<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MiniSheenasNest Chat</title>
  <style>
    /* Same CSS styles as before */
    <link rel="stylesheet" href="/styles.css">
  </style>
</head>
<body>

<!-- Navbar -->
<div class="navbar">
  <a href="index.html">Home</a>
  <a href="index.html">Chat</a>
  <a href="taskmanager.html">Task Manager</a>
  <a href="aboutus.html">About Us</a>
</div>

<!-- Login Modal -->
<div id="login-modal" class="modal">
  <div class="modal-content">
    <h2>What's your name?</h2>
    <input type="text" id="user-name-input" placeholder="Enter Sheena or Nord">
    <br>
    <button id="login-button">Login</button>
    <p id="login-error">Invalid name. Only "Sheena" or "Nord" allowed.</p>
  </div>
</div>

<!-- Chat Container -->
<div id="chat-container" class="chat-container">
  <div class="chat-header">
    <div class="user-info" id="other-user-info">
      <img id="other-user-img" src="" alt="">
      <h2 id="other-user-name"></h2>
    </div>
    <div class="user-info" id="current-user-info">
      <img id="current-user-img" src="" alt="">
      <h2 id="current-user-name"></h2>
    </div>
  </div>
  <div class="chat-messages" id="chat-messages">
    <ul class="chat-list" id="chat-list">
      <!-- Chat messages will be rendered here -->
    </ul>
  </div>
  <div class="chat-input-area">
    <form id="chat-form" class="chat-form">
      <textarea id="content" placeholder="Type your message..."></textarea>
      <button type="submit">Send</button>
    </form>
  </div>
</div>

<script type="module">
  // Import Firebase functions
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyB6tDk5iNJNBkBRVqwPMBTrCm6o74Wd7mc",
    authDomain: "thenordschannel.firebaseapp.com",
    projectId: "thenordschannel",
    storageBucket: "thenordschannel.firebasestorage.app",
    messagingSenderId: "924322422013",
    appId: "1:924322422013:web:51cf72f375e18376c7b294"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Define allowed users
  const users = {
    Sheena: { name: "Sheena", img: "images/sheena.jpg" },
    Nord: { name: "Nord", img: "images/nord.jpg" }
  };

  let currentUser, otherUser;
  let messages = [];

  // Login handling
  document.getElementById("login-button").addEventListener("click", function() {
    const inputName = document.getElementById("user-name-input").value.trim().toLowerCase();
    const errorEl = document.getElementById("login-error");
    errorEl.style.display = "none";
    
    if (inputName === "sheena") {
      currentUser = users.Sheena;
      otherUser = users.Nord;
      initChat();
    } else if (inputName === "nord") {
      currentUser = users.Nord;
      otherUser = users.Sheena;
      initChat();
    } else {
      errorEl.style.display = "block";
    }
  });

  // Initialize chat UI after successful login
  function initChat() {
    // Set header images and names
    document.getElementById("current-user-img").src = currentUser.img;
    document.getElementById("current-user-img").alt = currentUser.name;
    document.getElementById("current-user-name").innerText = currentUser.name;
    document.getElementById("other-user-img").src = otherUser.img;
    document.getElementById("other-user-img").alt = otherUser.name;
    document.getElementById("other-user-name").innerText = otherUser.name;
    
    // Hide login modal, show chat container
    document.getElementById("login-modal").style.display = "none";
    document.getElementById("chat-container").style.display = "flex";

    // Listen for real-time chat updates
    listenForMessages();
  }

  // Listen for real-time updates from Firestore
  function listenForMessages() {
    const chatRef = collection(db, "messages");
    
    // Filter by sender and receiver
    onSnapshot(chatRef, (snapshot) => {
      messages = [];
      snapshot.forEach(doc => {
        const msg = doc.data();
        if (
          (msg.sender === currentUser.name && msg.receiver === otherUser.name) ||
          (msg.sender === otherUser.name && msg.receiver === currentUser.name)
        ) {
          messages.push(msg);
        }
      });
      renderMessages();
    });
  }

  // Render messages
  function renderMessages() {
    const chatList = document.getElementById("chat-list");
    chatList.innerHTML = "";
    messages.forEach(msg => {
      const li = document.createElement("li");
      li.classList.add("chat-bubble");
      li.classList.add(msg.sender === currentUser.name ? "outgoing" : "incoming");
      li.innerHTML = `<span>${msg.content}</span>
                      <div class="bubble-footer">
                        ${new Date(msg.sentAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} 
                        ${msg.isRead ? "✔✔" : "✔"}
                      </div>`;
      chatList.appendChild(li);
    });
    const chatMessages = document.getElementById("chat-messages");
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Send message to Firestore
  document.getElementById("chat-form").addEventListener("submit", async function(e) {
    e.preventDefault();
    const contentEl = document.getElementById("content");
    const text = contentEl.value.trim();
    if (text === "") return;

    const newMsg = {
      sender: currentUser.name,
      receiver: otherUser.name,
      content: text,
      sentAt: new Date(),
      isRead: false
    };

    try {
      // Add new message to Firestore
      await addDoc(collection(db, "messages"), newMsg);
    } catch (e) {
      console.error("Error adding document: ", e);
    }

    contentEl.value = "";
  });
</script>

</body>
</html>
